---
title: "Data Analysis Code"
author: "Ryan Godin, Saman Ghazvini, William Amendola Bye, Jordyn Eovito, Vencke Gruening"
date: "`r Sys.Date()`"
output: pdf_document
---

This code tries to reproduce a select portion of figures from [Chen et al., 2023's](https://doi.org/10.1021/acssynbio.2c00662) *Deep Mutational Scanning of an Oxygen-Independent Fluorescent Protein CreiLOV for Comprehensive Profiling of Mutational and Epistatic Effects*. To run this code, please ensure that the raw data from the paper has been processed and saved in `data/processed` by running the code in `data_processing.RMD`.

The following libraries are needed for the data processing.

```{R}
#rm(list = ls())
library(tidyr)
library(tidyverse)
library(ggbeeswarm)
library(ggplot2)
library(ggpmisc)
library(scales)
```

## Figure Reproduction

### Load the data

```{R}
single_mutant_data <- read.csv("data/processed/single_mutant_data.csv")
combinatorial_mutation_data <- read.csv("data/processed/combinatorial_mutant_data.csv")
```

Checking the first few lines, last few lines, and dimensions of the file to see if the data loaded correctly.

```{R}
head(single_mutant_data)
tail(single_mutant_data)
dim(single_mutant_data)

head(combinatorial_mutation_data)
tail(combinatorial_mutation_data)
dim(combinatorial_mutation_data)
```

### Reproducing Figure 1B

We first calculate the $R$ correlation coefficient and the regression equation so we can annotate the ggplots with them.

```{R}
# Calculate regression data and make labels for plots
regression_12 <- lm(single_mutant_data$rep1 ~ single_mutant_data$rep2)
slope_12 <- coef(regression_12)[2]
r_12 <- cor(single_mutant_data$rep1, single_mutant_data$rep2, use = "complete.obs")
r_label_12 <- paste("italic(R) == ", format(round(r_12, 3), nsmall = 3))
eq_12 <- paste("y == ", round(slope_12, 3), " * x", sep = "")

regression_13 <- lm(single_mutant_data$rep1 ~ single_mutant_data$rep3)
slope_13 <- coef(regression_13)[2]
r_13 <- cor(single_mutant_data$rep1, single_mutant_data$rep3, use = "complete.obs")
r_label_13 <- paste("italic(R) == ", format(round(r_13, 3), nsmall = 3))
eq_13 <- paste("y == ", round(slope_13, 3), " * x", sep = "")

regression_23 <- lm(single_mutant_data$rep3 ~ single_mutant_data$rep2)
slope_23 <- coef(regression_23)[2]
r_23 <- cor(single_mutant_data$rep2, single_mutant_data$rep3, use = "complete.obs")
r_label_23 <- paste("italic(R) == ", format(round(r_23, 3), nsmall = 3))
eq_23 <- paste("y == ", round(slope_23, 3), " * x", sep = "")
```

We next generate the annotated figures and save the subplots to `figures/fig_1b`.

```{R}
fig_1b_1 <- ggplot(single_mutant_data, aes(x = rep1, y = rep2)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  annotate(
    "text",
    x = min(single_mutant_data$rep1),
    y = max(single_mutant_data$rep2),
    label = eq_12,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  annotate(
    "text",
    x = min(single_mutant_data$rep1),
    y = max(single_mutant_data$rep2) - 2000,
    label = r_label_12,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  labs(title = "Regression Plot for Replicate 1 vs Replicate 2", x = "Replicate 1", y = "Replicate 2")

fig_1b_2 <- ggplot(single_mutant_data, aes(x = rep1, y = rep3)) +
  geom_point() +
  geom_smooth(method = "lm", col = "green") +
  annotate(
    "text",
    x = min(single_mutant_data$rep1),
    y = max(single_mutant_data$rep3),
    label = eq_13,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  annotate(
    "text",
    x = min(single_mutant_data$rep1),
    y = max(single_mutant_data$rep3) - 2000,
    label = r_label_13,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  labs(title = "Regression Plot for Replicate 1 vs Replicate 3", x = "Replicate 1", y = "Replicate 3")

fig_1b_3 <- ggplot(single_mutant_data, aes(x = rep2, y = rep3)) +
  geom_point() +
  geom_smooth(method = "lm", col = "red") +
  annotate(
    "text",
    x = min(single_mutant_data$rep2),
    y = max(single_mutant_data$rep3),
    label = eq_23,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  annotate(
    "text",
    x = min(single_mutant_data$rep2),
    y = max(single_mutant_data$rep3) - 2000,
    label = r_label_23,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  labs(title = "Regression Plot for Replicate 2 vs Replicate 3", x = "Replicate 2", y = "Replicate 3")


# Print and save the plots and associated data.
ggsave("figures/fig_1b/fig_1b_1.png", plot = fig_1b_1)
print(fig_1b_1)

ggsave("figures/fig_1b/fig_1b_2.png", plot = fig_1b_2)
print(fig_1b_2)

ggsave("figures/fig_1b/fig_1b_3.png", plot = fig_1b_3)
print(fig_1b_3)
```

### Reproducing Figure 2A

We first load the target wild-type value so that it can be highlighted in the histogram.

```{R}
target_value <- single_mutant_data[1,"log_mean"]
print(target_value)
```

We next generate and format the histogram.

```{R}
## Plot and format the histogram to see if it looks like the paper.
fig_2a <- ggplot(single_mutant_data, aes(x = log_mean, y = after_stat(ndensity))) +
  geom_histogram(
    aes(fill = after_stat(xmin) <= target_value &
          after_stat(xmax) > target_value),
    bins = 47,
    color = "black"
  ) +
  scale_fill_manual(values = c("TRUE" = "red", "FALSE" = "black"),
                    guide = "none") +
  labs(x = "Fluorescence (log)", y = "Frequency") +
  scale_x_continuous(
    limits = c(2, 5),
    breaks = seq(2, 5, by = 0.5),
    labels = sprintf("%.2f", seq(2, 5, by = 0.5)),
    expand = c(0, 0)
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 16, color = "black"),
    axis.ticks = element_line(color = "black", size = 0.8),
    axis.ticks.length = unit(0.3, "cm"),
    axis.line = element_line(color = "black", size = 0.8)
  )

ggsave("figures/fig_2a.png", plot = fig_2a)
print(fig_2a)
```

### Reproducing Figure 2B

We first extract the necessary data and format it for the heatmap.

```{R}
# Restrict positions to 1-120 and drops those with invalid amino acids.
df_parsed <- filter(
  single_mutant_data,
  position >= 1,
  position <= 120,
  !is.na(wt_amino_acid),
  !is.na(mutant_amino_acid)
)

# Custom amino acid order for Y-axis
aa_order <- c(
  'P',
  'G',
  'F',
  'W',
  'Y',
  'A',
  'I',
  'L',
  'V',
  'C',
  'M',
  'N',
  'Q',
  'S',
  'T',
  'H',
  'K',
  'R',
  'D',
  'E'
)

df_parsed <- df_parsed %>%
  mutate(mutant_amino_acid = factor(mutant_amino_acid, levels = aa_order)
)
```

We then plot the heatmap.

```{R}
# Plot heatmap with all desired features
fig_2b_heatmap <-  ggplot(df_parsed, aes(x = position, y = mutant_amino_acid, fill = mean)) +
  geom_tile(color = "black", linewidth = 0.3) +  # Black borders for tiles
  scale_fill_gradient2(
    low = "darkblue",
    mid = "white",
    high = "darkred",
    midpoint = 14803,
    na.value = "gray80",
    # Lighter gray for missing values
    name = "Fluorescence"
  ) +
  theme_minimal() +
  coord_fixed() +  # Makes tiles square
  theme(
    axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1,
      size = 7
    ),
    axis.text.y = element_text(size = 4, face = "bold"),
    legend.position = "right",
    legend.key.height = unit(0.5, "cm")  # Taller legend for better color gradient
  ) +
  labs(x = "Position", y = "Mutant Amino Acid", title = "Fluorescence Heatmap")

ggsave("figures/fig_2b_heatmap.png", plot = fig_2b_heatmap,width = 10, height = 6)
print(fig_2b_heatmap)
```

We next generate the figure for the second part of Figure 2B.

```{R}
fig_2b_lower <- ggplot(single_mutant_data, mapping = aes(x = as.factor(position), y = mean)) + 
  geom_boxplot(fill = "black", outlier.shape = NA) + scale_x_discrete(breaks = seq(10, 110, by = 10)) + 
  xlab("Position in CreiLOV Protein") + ylab("Fluorescence") + scale_y_log10(
    breaks = c(1e3, 1e4),
    labels = scales::trans_format("log10", math_format(10^.x))
  ) + 
  theme_classic()

ggsave("figures/fig_2b_lower.png", fig_2b_lower, width = 16, height = 2)
```
