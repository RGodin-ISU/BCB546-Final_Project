---
title: "Data Analysis Code"
author: "Ryan Godin, Saman Ghazvini, William Amendola Bye, Jordyn Eovito, Vencke Gruening"
date: "`r Sys.Date()`"
output: pdf_document
---

This code tries to reproduce a select portion of figures from [Chen et al., 2023's](https://doi.org/10.1021/acssynbio.2c00662) *Deep Mutational Scanning of an Oxygen-Independent Fluorescent Protein CreiLOV for Comprehensive Profiling of Mutational and Epistatic Effects*. To run this code, please ensure that the raw data from the paper has been processed and saved in `data/processed` by running the code in `data_processing.RMD`.

The following libraries are needed for the data processing.

```{R}
#rm(list = ls())
library(tidyr)
library(tidyverse)
library(ggbeeswarm)
library(ggplot2)
library(ggpmisc)
```

## Figure Reproduction

### Load the data

```{R}
single_mutant_data <- read.csv("data/processed/single_mutant_data.csv")
combinatorial_mutation_data <- read.csv("data/processed/combinatorial_mutant_data.csv")
```

Checking the first few lines, last few lines, and dimensions of the file to see if the data loaded correctly.

```{R}
head(single_mutant_data)
tail(single_mutant_data)
dim(single_mutant_data)

head(combinatorial_mutation_data)
tail(combinatorial_mutation_data)
dim(combinatorial_mutation_data)
```

### Reproducing Figure 1B

We first calculate the $R$ correlation coefficient and the regression equation so we can annotate the ggplots with them.

```{R}
# Calculate regression data and make labels for plots
regression_12 <- lm(single_mutant_data$rep1 ~ single_mutant_data$rep2)
slope_12 <- coef(regression_12)[2]
r_12 <- cor(single_mutant_data$rep1, single_mutant_data$rep2, use = "complete.obs")
r_label_12 <- paste("italic(R) == ", format(round(r_12, 3), nsmall = 3))
eq_12 <- paste("y == ", round(slope_12, 3), " * x", sep = "")

regression_13 <- lm(single_mutant_data$rep1 ~ single_mutant_data$rep3)
slope_13 <- coef(regression_13)[2]
r_13 <- cor(single_mutant_data$rep1, single_mutant_data$rep3, use = "complete.obs")
r_label_13 <- paste("italic(R) == ", format(round(r_13, 3), nsmall = 3))
eq_13 <- paste("y == ", round(slope_13, 3), " * x", sep = "")

regression_23 <- lm(single_mutant_data$rep3 ~ single_mutant_data$rep2)
slope_23 <- coef(regression_23)[2]
r_23 <- cor(single_mutant_data$rep2, single_mutant_data$rep3, use = "complete.obs")
r_label_23 <- paste("italic(R) == ", format(round(r_23, 3), nsmall = 3))
eq_23 <- paste("y == ", round(slope_23, 3), " * x", sep = "")
```

We next generate the annotated figures and save the subplots to `figures/fig_1b`.

```{R}
fig_1b_1 <- ggplot(single_mutant_data, aes(x = rep1, y = rep2)) +
  geom_point() +
  geom_smooth(method = "lm", col = "blue") +
  annotate(
    "text",
    x = min(single_mutant_data$rep1),
    y = max(single_mutant_data$rep2),
    label = eq_12,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  annotate(
    "text",
    x = min(single_mutant_data$rep1),
    y = max(single_mutant_data$rep2) - 2000,
    label = r_label_12,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  labs(title = "Regression Plot for Replicate 1 vs Replicate 2", x = "Replicate 1", y = "Replicate 2")

fig_1b_2 <- ggplot(single_mutant_data, aes(x = rep1, y = rep3)) +
  geom_point() +
  geom_smooth(method = "lm", col = "green") +
  annotate(
    "text",
    x = min(single_mutant_data$rep1),
    y = max(single_mutant_data$rep3),
    label = eq_13,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  annotate(
    "text",
    x = min(single_mutant_data$rep1),
    y = max(single_mutant_data$rep3) - 2000,
    label = r_label_13,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  labs(title = "Regression Plot for Replicate 1 vs Replicate 3", x = "Replicate 1", y = "Replicate 3")

fig_1b_3 <- ggplot(single_mutant_data, aes(x = rep2, y = rep3)) +
  geom_point() +
  geom_smooth(method = "lm", col = "red") +
  annotate(
    "text",
    x = min(single_mutant_data$rep2),
    y = max(single_mutant_data$rep3),
    label = eq_23,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  annotate(
    "text",
    x = min(single_mutant_data$rep2),
    y = max(single_mutant_data$rep3) - 2000,
    label = r_label_23,
    parse = TRUE,
    hjust = 0,
    vjust = 1,
    size = 4
  ) +
  labs(title = "Regression Plot for Replicate 2 vs Replicate 3", x = "Replicate 2", y = "Replicate 3")


# Print and save the plots and associated data.
print(fig_1b_1)
ggsave("figures/fig_1b/fig_1b_1.png", plot = fig_1b_1)

print(fig_1b_2)
ggsave("figures/fig_1b/fig_1b_2.png", plot = fig_1b_2)

print(fig_1b_3)
ggsave("figures/fig_1b/fig_1b_3.png", plot = fig_1b_3)
```

### Reproducing Figure 2A

We first load the target wild-type value so that it can be highlighted in the histogram.

```{R}
target_value <- single_mutant_data[1,"log_mean"]
print(target_value)
```

We next generate and format the histogram.

```{R}
## Plot and format the histogram to see if it looks like the paper.
fig_2a <- ggplot(single_mutant_data, aes(x = log_mean, y = after_stat(ndensity))) +
  geom_histogram(
    aes(fill = after_stat(xmin) <= target_value &
          after_stat(xmax) > target_value),
    bins = 47,
    color = "black"
  ) +
  scale_fill_manual(values = c("TRUE" = "red", "FALSE" = "black"),
                    guide = "none") +
  labs(x = "Fluorescence (log)", y = "Frequency") +
  scale_x_continuous(
    limits = c(2, 5),
    breaks = seq(2, 5, by = 0.5),
    labels = sprintf("%.2f", seq(2, 5, by = 0.5)),
    expand = c(0, 0)
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic() +
  theme(
    axis.text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 16, color = "black"),
    axis.ticks = element_line(color = "black", size = 0.8),
    axis.ticks.length = unit(0.3, "cm"),
    axis.line = element_line(color = "black", size = 0.8)
  )

print(fig_2a)
ggsave("figures/fig_2a.png", plot = fig_2a)
```